<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventory Management System</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --primary-color: #006341;
      --secondary-color: #d4e9e2;
      --accent-color: #1e3932;
      --light-color: #f9f9f9;
      --dark-color: #2b2b2b;
      --error-color: #d62b1f;
      --success-color: #4caf50;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Roboto', sans-serif;
      line-height: 1.6;
      color: var(--dark-color);
      padding: 20px;
    }
    /* ---------- Popup Message Styling (using a nice background image) ---------- */
    #popup-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 11000;
      padding: 20px;
      background: url('asset/images/nice_popup.png') no-repeat center center;
      background-size: contain;
      color: #fff;
      font-weight: bold;
      text-align: center;
      font-size: 1.2rem;
      line-height: 1.4;
      display: none;
      width: 300px;
      height: 150px;
      border-radius: 10px;
    }
    /* ---------- Custom Confirm Popup (using the same nice popup image) ---------- */
    .custom-confirm-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 12000;
    }
    .custom-confirm-container {
      background: url('asset/images/nice_popup.png') no-repeat center center;
      background-size: contain;
      width: 300px;
      height: 150px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
      border-radius: 10px;
      text-align: center;
      padding: 20px;
    }
    .custom-confirm-buttons {
      margin-top: 20px;
    }
    .custom-confirm-buttons button {
      margin: 0 10px;
      padding: 5px 10px;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    /* ---------- Role Selection Overlay ---------- */
    #role-selection {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('asset/images/StarbucksLogo.jpg') no-repeat center center fixed;
      background-size: cover;
      z-index: 10000;
    }
    /* Card-style container at bottom */
    #role-selection .role-container {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 20px 40px;
      border-radius: 10px;
      text-align: center;
    }
    #role-selection h2 {
      margin-bottom: 20px;
      font-size: 1.8rem;
      color: var(--accent-color);
    }
    #role-selection button {
      width: 200px;
      padding: 10px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }
    /* Manager button: green with white text */
    #role-selection button[data-role="manager"] {
      background-color: var(--primary-color);
      color: #fff;
    }
    /* Lead button: white with dark text */
    #role-selection button[data-role="lead"] {
      background-color: #fff;
      color: var(--dark-color);
      border: 2px solid var(--accent-color);
    }
    /* ADMIN button: red with white text */
    #role-selection button[data-role="admin"] {
      background-color: red;
      color: #fff;
      border: 2px solid darkred;
    }
    #role-selection button:hover {
      transform: scale(1.05);
    }
    /* ---------- Password Overlays ---------- */
    .password-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    .password-container {
      background: #fff;
      padding: 30px 40px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      text-align: center;
    }
    .password-container input {
      font-size: 1.8rem;
      padding: 10px 20px;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: center;
      width: 250px;
      margin-bottom: 20px;
    }
    .password-container button {
      font-size: 1.8rem;
      padding: 8px 16px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-ok {
      background-color: var(--success-color);
      color: #fff;
    }
    .btn-back,
    .btn-home {
      background-color: var(--accent-color);
      color: #fff;
    }
    /* ---------- Store Selection Overlay ---------- */
    #store-selection {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9000;
    }
    #store-selection .store-container {
      background: #fff;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      text-align: center;
      position: relative;
    }
    #store-selection h2 {
      margin-bottom: 20px;
      color: var(--accent-color);
      font-size: 1.5rem;
    }
    #store-selection .store-btn {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      font-size: 1.2rem;
      cursor: pointer;
      background-color: var(--primary-color);
      color: white;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }
    #store-selection .store-btn:hover {
      background-color: #004d33;
      transform: scale(1.05);
    }
    #store-selection .home-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.5rem;
      padding: 10px 20px;
    }
    /* ---------- Main Application Styles (Manager/Lead) ---------- */
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      display: none;
      min-height: 100vh;
      background: url('asset/images/starbucksInventoryBg.jpg') no-repeat center center;
      background-size: cover;
    }
    #global-home-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 1rem;
      padding: 5px 10px;
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      z-index: 1000;
    }
    #global-home-btn:hover {
      background-color: #0f2a22;
    }
    .switch-store-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 5px 10px;
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.3s ease;
    }
    .switch-store-btn:hover {
      background-color: #0f2a22;
    }
    @media (max-width: 400px) {
      .switch-store-btn {
        top: 70px;
      }
    }
    h1 {
      color: var(--primary-color);
      text-align: center;
      margin-bottom: 30px;
      font-weight: 700;
    }
    .categories {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    .category {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      transition: transform 0.3s ease;
    }
    .category:hover {
      transform: translateY(-5px);
    }
    .category h2 {
      color: var(--accent-color);
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--secondary-color);
      font-size: 1.2rem;
    }
    .item-list {
      list-style: none;
      margin-bottom: 15px;
    }
    .item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    .item-label {
      width: 150px;
      font-size: 0.9rem;
      margin-right: 10px;
    }
    .item-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .item-input:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    .item-actions {
      display: flex;
      margin-left: 10px;
    }
    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
      transition: background-color 0.3s ease;
    }
    .btn-add {
      background-color: var(--success-color);
      color: white;
      margin-right: 5px;
    }
    .btn-add:hover {
      background-color: #3d8b40;
    }
    .btn-remove {
      background-color: var(--error-color);
      color: white;
    }
    .btn-remove:hover {
      background-color: #bb241a;
    }
    .section-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }
    .clear-section {
      background-color: #f8f8f8;
      color: var(--error-color);
      border: 1px solid var(--error-color);
    }
    .clear-section:hover {
      background-color: #f0f0f0;
    }
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 30px 0;
    }
    .action-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .generate-btn {
      background-color: var(--primary-color);
      color: white;
    }
    .generate-btn:hover {
      background-color: #004d33;
    }
    .copy-btn {
      background-color: var(--accent-color);
      color: white;
    }
    .copy-btn:hover {
      background-color: #0f2a22;
    }
    .clear-btn {
      background-color: var(--error-color);
      color: white;
    }
    .clear-btn:hover {
      background-color: #bb241a;
    }
    .output {
      margin-top: 20px;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      white-space: pre-wrap;
      font-family: monospace;
      min-height: 100px;
      max-height: 400px;
      overflow-y: auto;
    }
    .output-title {
      color: var(--accent-color);
      margin-bottom: 10px;
      font-weight: 500;
    }
    .notes-section {
      margin-top: 30px;
    }
    .notes-title {
      color: var(--accent-color);
      margin-bottom: 10px;
      font-weight: 500;
    }
    .notes-textarea {
      width: 100%;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: 'Roboto', sans-serif;
      font-size: 1rem;
      resize: none;
      min-height: 150px;
      margin-bottom: 15px;
    }
    .notes-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    .save-notes-btn {
      background-color: var(--primary-color);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    .save-notes-btn:hover {
      background-color: #004d33;
    }
    /* ---------- Admin Panel Styles (Improved UX) ---------- */
    #admin-container {
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background-color: #fff;
      border: 2px solid var(--error-color);
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      display: none;
    }
    #admin-container h1 {
      text-align: center;
      color: darkred;
      margin-bottom: 20px;
    }
    .admin-section {
      margin-bottom: 20px;
    }
    .admin-section label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: var(--accent-color);
    }
    .admin-section select,
    .admin-section input {
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .admin-section button {
      width: 100%;
      padding: 10px;
      font-size: 1rem;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 10px;
      transition: background-color 0.3s ease;
    }
    .admin-section button:hover {
      background-color: #004d33;
    }
  </style>
</head>
<body>
  <!-- Popup Message -->
  <div id="popup-message"></div>
  
  <!-- Custom Confirm Overlay -->
  <div id="custom-confirm" class="custom-confirm-overlay">
    <div class="custom-confirm-container">
      <p id="custom-confirm-message"></p>
      <div class="custom-confirm-buttons">
        <button id="custom-confirm-yes">Yes</button>
        <button id="custom-confirm-no">No</button>
      </div>
    </div>
  </div>

  <!-- Role Selection Overlay -->
  <div id="role-selection">
    <div class="role-container">
      <h2>Select Your Role</h2>
      <button data-role="manager">Manager</button>
      <button data-role="lead">Lead</button>
      <button data-role="admin">Admin</button>
    </div>
  </div>

  <!-- Manager Password Overlay -->
  <div id="manager-password-screen" class="password-overlay">
    <div class="password-container">
      <h2>Manager Login</h2>
      <form id="manager-password-form">
        <input type="password" id="manager-password-input" placeholder="Enter Manager Password" autofocus />
        <br />
        <button type="submit" class="btn-ok">&#10004;</button>
        <button type="button" id="manager-back-btn" class="btn-back">Back</button>
        <button type="button" id="manager-home-btn" class="btn-home">Home</button>
      </form>
    </div>
  </div>

  <!-- Admin Password Overlay -->
  <div id="admin-password-screen" class="password-overlay">
    <div class="password-container">
      <h2>Admin Login</h2>
      <form id="admin-password-form">
        <input type="password" id="admin-password-input" placeholder="Enter Admin Password" autofocus />
        <br />
        <button type="submit" class="btn-ok">&#10004;</button>
        <button type="button" id="admin-back-btn" class="btn-back">Back</button>
        <button type="button" id="admin-password-home-btn" class="btn-home">Home</button>
      </form>
    </div>
  </div>

  <!-- Store Selection Overlay -->
  <div id="store-selection">
    <div class="store-container">
      <h2>Select a Store</h2>
      <button class="store-btn" data-store="HeadHouse">HeadHouse</button>
      <button class="store-btn" data-store="Mobile">Mobile</button>
      <button class="store-btn" data-store="D">D</button>
      <button class="store-btn" data-store="Baggage">Baggage</button>
      <button class="store-btn" data-store="Departures">Departures</button>
      <button class="store-btn" data-store="Connector">Connector</button>
      <button type="button" class="home-btn" id="store-selection-home-btn">Home</button>
    </div>
  </div>

  <!-- Store Password Overlay (for Lead users only) -->
  <div id="store-password-screen" class="password-overlay">
    <div class="password-container">
      <h2>Store Login</h2>
      <form id="store-password-form">
        <input type="password" id="store-password-input" placeholder="Enter store password" autofocus />
        <br />
        <button type="submit" class="btn-ok">&#10004;</button>
        <button type="button" id="store-back-btn" class="btn-back">Back</button>
        <button type="button" id="store-home-btn" class="btn-home">Home</button>
      </form>
    </div>
  </div>

  <!-- Main Application Container (Manager/Lead) -->
  <div class="container" id="main-container">
    <button id="global-home-btn">Home</button>
    <button id="switch-store-btn" class="switch-store-btn">Switch Store</button>
    <h1 id="main-heading">Inventory Management System</h1>
    <div class="categories" id="categories-container">
      <!-- Categories injected dynamically -->
    </div>
    <div class="action-buttons">
      <button class="action-btn generate-btn" id="generate-btn">Generate List</button>
      <button class="action-btn copy-btn" id="copy-btn">Copy List</button>
      <button class="action-btn clear-btn" id="clear-btn">Clear All</button>
    </div>
    <div class="output">
      <div class="output-title">Generated List:</div>
      <div id="output-content"></div>
    </div>
    <div class="notes-section">
      <div class="notes-title">Notes:</div>
      <textarea class="notes-textarea" id="notes-textarea" placeholder="Enter your notes here..."></textarea>
      <button class="save-notes-btn" id="save-notes-btn">Save Notes</button>
    </div>
  </div>

  <!-- Admin Panel Container (Improved UI) -->
  <div id="admin-container">
    <button id="admin-home-btn">Return Home</button>
    <h1>ADMIN PANEL</h1>
    <div class="admin-section" id="update-password-section">
      <label for="password-role-select">Select Role to Update Password:</label>
      <select id="password-role-select">
        <option value="manager">Manager</option>
        <option value="HeadHouse">HeadHouse</option>
        <option value="Mobile">Mobile</option>
        <option value="D">D</option>
        <option value="Baggage">Baggage</option>
        <option value="Departures">Departures</option>
        <option value="Connector">Connector</option>
      </select>
      <label for="new-password-input">New Password:</label>
      <input type="password" id="new-password-input" placeholder="Enter new password" />
      <button id="update-password-btn">Update Password</button>
    </div>
    <div class="admin-section" id="reset-password-section">
      <button id="reset-password-btn">Reset All Passwords to Default</button>
    </div>
    <div class="admin-section" id="sign-out-section">
      <button id="sign-out-all-btn">Sign Everyone Out</button>
    </div>
  </div>

  <script>
    // ------------------ Helper: Hashing Function using SHA-256 ------------------
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // ------------------ Popup Message ------------------
    function showPopup(message) {
      const popup = document.getElementById('popup-message');
      popup.textContent = message;
      popup.style.display = 'block';
      setTimeout(() => {
        popup.style.display = 'none';
      }, 3000);
    }

    // ------------------ Custom Confirm Dialog ------------------
    function customConfirm(message) {
      return new Promise((resolve, reject) => {
        const confirmOverlay = document.getElementById('custom-confirm');
        const messageElem = document.getElementById('custom-confirm-message');
        const yesButton = document.getElementById('custom-confirm-yes');
        const noButton = document.getElementById('custom-confirm-no');
        messageElem.textContent = message;
        confirmOverlay.style.display = 'flex';
        yesButton.onclick = () => { confirmOverlay.style.display = 'none'; resolve(true); };
        noButton.onclick = () => { confirmOverlay.style.display = 'none'; resolve(false); };
      });
    }

    // ------------------ Global Variables & Default Passwords (plain text defaults) ------------------
    let currentRole = "";  // "lead", "manager" or "admin"
    let selectedStore = "";
    let pendingStore = ""; // For lead mode pending store password entry

    // Default passwords (plain text)
    const DEFAULT_MANAGER_PASSWORD = "Access";
    const DEFAULT_STORE_PASSWORDS = {
      HeadHouse: "0101",
      Mobile: "0000",
      D: "1010",
      Baggage: "1111",
      Departures: "1110",
      Connector: "0001"
    };
    const DEFAULT_ADMIN_PASSWORD = "Admin";

    // Global variables for hashed passwords (will be set on load)
    let managerPassword = "";
    let storePasswords = {};
    let ADMIN_PASSWORD_HASH = "";

    // ------------------ Load Passwords from Firebase & Initialize Defaults if Needed ------------------
    async function loadPasswords() {
      try {
        const snapshot = await database.ref('passwords').once('value');
        if (snapshot.exists()) {
          const data = snapshot.val();
          managerPassword = data.manager;  // Expected to be already hashed
          storePasswords = data.store;
        } else {
          managerPassword = await hashPassword(DEFAULT_MANAGER_PASSWORD);
          storePasswords = {};
          for (const store in DEFAULT_STORE_PASSWORDS) {
            storePasswords[store] = await hashPassword(DEFAULT_STORE_PASSWORDS[store]);
          }
          // Save hashed defaults to Firebase
          database.ref('passwords').set({
            manager: managerPassword,
            store: storePasswords
          });
        }
      } catch (error) {
        console.error(error);
      }
    }

    // Pre-calculate the admin password hash.
    hashPassword(DEFAULT_ADMIN_PASSWORD).then(hash => { ADMIN_PASSWORD_HASH = hash; });

    // ------------------ Global Home Function ------------------
    function goHome() {
      localStorage.removeItem("userRole");
      localStorage.removeItem("selectedStore");
      location.reload();
    }
    // Attach home to all known home buttons
    document.getElementById('manager-home-btn').addEventListener('click', goHome);
    document.getElementById('store-home-btn').addEventListener('click', goHome);
    document.getElementById('store-selection-home-btn').addEventListener('click', goHome);
    document.getElementById('admin-password-home-btn').addEventListener('click', goHome);
    document.getElementById('admin-home-btn').addEventListener('click', goHome);
    document.getElementById('global-home-btn').addEventListener('click', goHome);

    // ------------------ Role Selection ------------------
    document.querySelectorAll('#role-selection button').forEach(btn => {
      btn.addEventListener('click', function() {
        currentRole = this.getAttribute('data-role');
        document.getElementById('role-selection').style.display = 'none';
        if (currentRole === "manager") {
          document.getElementById('manager-password-screen').style.display = 'flex';
        } else if (currentRole === "lead") {
          document.getElementById('store-selection').style.display = 'flex';
        } else if (currentRole === "admin") {
          document.getElementById('admin-password-screen').style.display = 'flex';
        }
      });
    });

    // ------------------ Manager Password Check ------------------
    document.getElementById('manager-password-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const pwd = document.getElementById('manager-password-input').value;
      const hashedInput = await hashPassword(pwd);
      if (hashedInput === managerPassword) {
        localStorage.setItem("userRole", currentRole);
        document.getElementById('manager-password-screen').style.display = 'none';
        document.getElementById('store-selection').style.display = 'flex';
      } else {
        showPopup('Incorrect Manager Password.');
        document.getElementById('manager-password-input').value = '';
      }
    });
    document.getElementById('manager-back-btn').addEventListener('click', function() {
      document.getElementById('manager-password-screen').style.display = 'none';
      document.getElementById('role-selection').style.display = 'flex';
    });

    // ------------------ Admin Password Check ------------------
    document.getElementById('admin-password-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const pwd = document.getElementById('admin-password-input').value;
      const hashedInput = await hashPassword(pwd);
      if (hashedInput === ADMIN_PASSWORD_HASH) {
        localStorage.setItem("userRole", currentRole);
        document.getElementById('admin-password-screen').style.display = 'none';
        renderAdminUI();
      } else {
        showPopup('Incorrect Admin Password.');
        document.getElementById('admin-password-input').value = '';
      }
    });
    document.getElementById('admin-back-btn').addEventListener('click', function() {
      document.getElementById('admin-password-screen').style.display = 'none';
      document.getElementById('role-selection').style.display = 'flex';
    });

    // ------------------ Store Selection (Manager & Lead) ------------------
    document.querySelectorAll('#store-selection .store-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const store = this.getAttribute('data-store');
        if (currentRole === "manager") {
          selectedStore = store;
          localStorage.setItem("selectedStore", store);
          document.getElementById('store-selection').style.display = 'none';
          updateHeadingAndLoadData(store);
        } else {
          pendingStore = store;
          document.getElementById('store-selection').style.display = 'none';
          document.getElementById('store-password-input').placeholder = `Password for ${store}`;
          document.getElementById('store-password-screen').style.display = 'flex';
        }
      });
    });

    // ------------------ Store Password Check for Lead ------------------
    document.getElementById('store-password-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const pwd = document.getElementById('store-password-input').value;
      const hashedInput = await hashPassword(pwd);
      if (hashedInput === storePasswords[pendingStore]) {
        selectedStore = pendingStore;
        localStorage.setItem("userRole", currentRole);
        localStorage.setItem("selectedStore", pendingStore);
        document.getElementById('store-password-screen').style.display = 'none';
        updateHeadingAndLoadData(pendingStore);
      } else {
        showPopup('Incorrect store password.');
        document.getElementById('store-password-input').value = '';
      }
    });
    document.getElementById('store-back-btn').addEventListener('click', function() {
      document.getElementById('store-password-screen').style.display = 'none';
      document.getElementById('store-selection').style.display = 'flex';
    });

    // ------------------ Function to Update Heading & Load Data (Manager/Lead) ------------------
    function updateHeadingAndLoadData(store) {
      const headingText = (currentRole === "manager" ? "Manager" : "Lead") + " - " + store + " Inventory Management";
      document.getElementById('main-heading').textContent = headingText;
      document.getElementById('main-container').style.display = 'block';
      renderInventoryUI();
      loadInitialData();
      setupNotes();
      setupEventListeners();
    }

    // ------------------ Render Admin Panel UI ------------------
    function renderAdminUI() {
      document.getElementById('admin-container').style.display = 'block';
    }

    // ------------------ Switch Store Button ------------------
    document.getElementById('switch-store-btn').addEventListener('click', async function() {
      if (await customConfirm("Switch store? Unsaved changes might be lost.")) {
        document.getElementById('store-selection').style.display = 'flex';
      }
    });

    // ------------------ Persistent Session Check ------------------
    document.addEventListener('DOMContentLoaded', async function() {
      await loadPasswords();
      const storedRole = localStorage.getItem("userRole");
      const storedStore = localStorage.getItem("selectedStore");
      if (storedRole && storedStore) {
        currentRole = storedRole;
        selectedStore = storedStore;
        document.getElementById('role-selection').style.display = 'none';
        document.getElementById('manager-password-screen').style.display = 'none';
        document.getElementById('store-selection').style.display = 'none';
        document.getElementById('store-password-screen').style.display = 'none';
        if (currentRole === "admin") {
          renderAdminUI();
        } else {
          updateHeadingAndLoadData(storedStore);
        }
      }
    });

    // ------------------ Firebase Initialization ------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDuFjeruJPdkDLUOazyA_BzpTKA1SWT4bw",
      authDomain: "inventory-d35b5.firebaseapp.com",
      databaseURL: "https://inventory-d35b5-default-rtdb.firebaseio.com",
      projectId: "inventory-d35b5",
      storageBucket: "inventory-d35b5.firebasestorage.app",
      messagingSenderId: "512369551549",
      appId: "1:512369551549:web:0a8ba6d030fdad8c392fd4",
      measurementId: "G-0NYHYLDQED"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ------------------ Global Sign Out Listener ------------------
    database.ref('global/signOutTrigger').on('value', (snapshot) => {
      if (snapshot.exists() && snapshot.val()) {
        goHome();
      }
    });

    // ------------------ Inventory Functions (unchanged) ------------------
    const inventoryCategories = {
      milks: [
        "2%", "Whole Milk", "Nonfat", "Half n Half", "Heavy Cream",
        "Oatmilk", "Almond Milk", "Coconut Milk", "Soymilk", "Nondairy Vanilla Creamer"
      ],
      syrups: [
        "Vanilla", "SF Vanilla", "Caramel", "Classic", "Brown Sugar", "Cinamon Dolce",
        "Toffee Nut", "Hazelnut", "Honey", "Apple Brown Sugar", "Pepppermint",
        "Pecan", "Chai", "Coffee Base", "Creme Base", "Dark Caramel", "White Mocha",
        "Pumpkin Sauce"
      ],
      cups: [
        "Short Cups (8oz)", "Shot Cup Lids (8oz)", "Tall Hot Cups (12oz)",
        "Tall Hot Lids (12oz)", "Tall Ice Cups (12oz)", "Tall Ice Lids (12oz)",
        "Grande Hot Cups (16oz)", "Grande Hot Lids (16oz)", "Grande Ice Cups (16oz)",
        "Grande Ice Lids (16oz)", "Grande Dome Lids", "Venti Hot Cups (20oz)",
        "Venti Hot Lids (20oz)", "Venti Ice Cups (26oz)", "Venti Ice Lids (26oz)",
        "Venti Dome Lids", "Trenta Cups (30oz)", "Trenta Lids (30oz)"
      ],
      rtd: [
        "Thats it Bars (blueberry)", "Thats it Bars (mango)", "SkinnyDip (lemon)",
        "SkinnyDip (chocolate)", "Kind Bars", "Perfect Bars (chocolate)",
        "Perfect Bars (pb)", "Vanilla Almond Biscoti", "Cheese Trio Bistro",
        "Cheddar & Salami Bistro", "Egg Gouda Bistro", "Horizon Lowfat Milk",
        "Horizon Chocolate Milk", "Apple Juice Box", "Peter Rabbit Strawberry Banana",
        "TripleShot Energy", "Koia Vanilla Bean", "Koia Cacao Bean",
        "Olipop Classic Root Beer", "Olipop Grape", "Starbucks Popcorn",
        "Salted Chips", "Ethos"
      ],
      warming: [
        "Core Warming Bag", "Pastry Bag", "Panini Bag", "Warming Paper", "Forks",
        "Spoons", "Knives", "Egg Trays", "Oatmeal", "Oatmeal (cup)", "Oatmeal(lid)",
        "Sugar in raw", "Honey Packets", "Splenda", "Stevia", "Domino Sugar",
        "Core Shopping Bags (small)", "Core Shopping Bags(Medium)"
      ],
      toppings: [
        "Crunch Toppings", "Cookie Crumbles", "Cinnamon", "Pumpkin"
      ],
      refresher: [
        "Strawberry Acai", "Mango DF", "BlackBerry Sage", "Strawberry Inclusions",
        "Mango DF Inclusions", "Blackberry Sage Inclusions", "Peach", "Lemonade",
        "Strawberry Puree"
      ],
      coffee: [
        "Pike Place", "Veranda", "Verona", "Espresso", "Blonde Espresso",
        "DCF Espresso", "Cold Brew", "Iced Coffee"
      ],
      teas: [
        "Chamomile Mint Blossom", "Mint Majesty", "Emperor's Cloud & Mist",
        "English Breakfast", "Earl Grey", "Chai", "Ice Black Tea", "Ice Green Tea",
        "Ice Passion Tea"
      ],
      cleaning: [
        "Saniwipes", "Rags", "Thermoplan Pills", "Oven Cleaner", "Grease Express",
        "Restroom Cleaner", "InstaSense Multi-Purpose Cleaner", "K-5 Cleaner/Sanitizer",
        "Urn Cleaner", "Peroxide Multi Surface Cleaner and Disinfectant",
        "Sanitizing Wash n Walk", "Sink and Surface Cleaner Sanitizer",
        "10-Inch Paper Tower Roll", "Starbucks Napkins", "Trifold Napkins",
        "Ecolab Foam Hand Soap"
      ],
      misc: [
        "Vanilla Bean Powder", "Matcha", "Chocolate Malt Powder", "Mocha",
        "Frap Chips", "Caramel Drizzle", "Sleeves", "Cup Holders", "Thermometers",
        "Cold Brew Filters", "Coffee Filters", "Whip Chargers", "Brillo Pads"
      ],
      merch: [
        "Discovery Mugs", "Coffee Bags"
      ]
    };

    function renderInventoryUI() {
      const container = document.getElementById('categories-container');
      container.innerHTML = '';
      for (const category in inventoryCategories) {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'category';
        const categoryTitle = document.createElement('h2');
        categoryTitle.textContent = category.charAt(0).toUpperCase() + category.slice(1);
        categoryDiv.appendChild(categoryTitle);
        const itemList = document.createElement('ul');
        itemList.className = 'item-list';
        itemList.id = `${category}-list`;
        inventoryCategories[category].forEach(item => {
          const listItem = createInventoryItem(category, item);
          itemList.appendChild(listItem);
        });
        categoryDiv.appendChild(itemList);
        const sectionActions = document.createElement('div');
        sectionActions.className = 'section-actions';
        const addButton = document.createElement('button');
        addButton.className = 'btn btn-add';
        addButton.textContent = 'Add Item';
        addButton.onclick = () => addNewItem(category);
        const clearButton = document.createElement('button');
        clearButton.className = 'btn clear-section';
        clearButton.textContent = 'Clear Section';
        clearButton.onclick = () => clearSection(category);
        sectionActions.appendChild(addButton);
        sectionActions.appendChild(clearButton);
        categoryDiv.appendChild(sectionActions);
        container.appendChild(categoryDiv);
      }
    }

    function loadInitialData() {
      database.ref('inventory/' + selectedStore).once('value').then((snapshot) => {
        const data = snapshot.val();
        if (data) {
          for (const category in data) {
            const itemList = document.getElementById(`${category}-list`);
            if (itemList) {
              for (const itemName in data[category]) {
                const itemValue = data[category][itemName];
                const input = itemList.querySelector(`input[data-item="${itemName}"]`);
                if (input) {
                  input.value = itemValue;
                }
              }
            }
          }
        }
      });
      database.ref('inventory/' + selectedStore).on('child_changed', (snapshot) => {
        const category = snapshot.key;
        const data = snapshot.val();
        const itemList = document.getElementById(`${category}-list`);
        if (itemList) {
          for (const itemName in data) {
            const itemValue = data[category][itemName];
            const input = itemList.querySelector(`input[data-item="${itemName}"]`);
            if (input) {
              input.value = itemValue;
            }
          }
        }
      });
    }

    function setupNotes() {
      const textarea = document.getElementById('notes-textarea');
      const saveBtn = document.getElementById('save-notes-btn');
      database.ref('notes/' + selectedStore).once('value').then((snapshot) => {
        if (snapshot.exists()) {
          textarea.value = snapshot.val();
        }
      });
      database.ref('notes/' + selectedStore).on('value', (snapshot) => {
        if (snapshot.exists()) {
          textarea.value = snapshot.val();
        }
      });
      saveBtn.addEventListener('click', () => {
        const notesText = textarea.value.trim();
        database.ref('notes/' + selectedStore).set(notesText)
          .then(() => showPopup('Notes saved!'))
          .catch(error => showPopup('Error saving notes: ' + error.message));
      });
      let typingTimer;
      textarea.addEventListener('input', () => {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
          const notesText = textarea.value.trim();
          database.ref('notes/' + selectedStore).set(notesText)
            .catch(error => console.error('Error auto-saving notes:', error));
        }, 2000);
      });
    }

    function createInventoryItem(category, itemName, itemValue = '') {
      const item = document.createElement('li');
      item.className = 'item';
      const label = document.createElement('div');
      label.className = 'item-label';
      label.textContent = itemName;
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'item-input';
      input.placeholder = 'Enter quantity...';
      input.value = itemValue;
      input.dataset.category = category;
      input.dataset.item = itemName;
      input.addEventListener('change', function() {
        const value = this.value.trim();
        updateInventoryItem(category, itemName, value);
      });
      const removeBtn = document.createElement('button');
      removeBtn.className = 'btn btn-remove';
      removeBtn.textContent = 'Remove';
      removeBtn.onclick = () => removeInventoryItem(category, itemName, item);
      const itemActions = document.createElement('div');
      itemActions.className = 'item-actions';
      itemActions.appendChild(removeBtn);
      item.appendChild(label);
      item.appendChild(input);
      item.appendChild(itemActions);
      return item;
    }

    async function addNewItem(category) {
      const newItemName = prompt('Enter new item name:');
      if (newItemName && newItemName.trim() !== '') {
        const itemList = document.getElementById(`${category}-list`);
        const newItem = createInventoryItem(category, newItemName);
        itemList.appendChild(newItem);
        database.ref(`inventory/${selectedStore}/${category}/${newItemName}`).set('');
        if (!inventoryCategories[category].includes(newItemName)) {
          inventoryCategories[category].push(newItemName);
        }
      }
    }

    async function removeInventoryItem(category, itemName, itemElement) {
      if (await customConfirm(`Are you sure you want to remove ${itemName}?`)) {
        database.ref(`inventory/${selectedStore}/${category}/${itemName}`).remove();
        itemElement.remove();
        const index = inventoryCategories[category].indexOf(itemName);
        if (index > -1) {
          inventoryCategories[category].splice(index, 1);
        }
      }
    }

    async function clearSection(category) {
      if (await customConfirm(`Are you sure you want to clear all items in ${category}?`)) {
        const inputs = document.querySelectorAll(`#${category}-list .item-input`);
        inputs.forEach(input => {
          input.value = '';
          const itemName = input.dataset.item;
          updateInventoryItem(category, itemName, '');
        });
      }
    }

    function updateInventoryItem(category, itemName, value) {
      database.ref(`inventory/${selectedStore}/${category}/${itemName}`).set(value);
    }

    function generateInventoryList() {
      let output = '';
      database.ref('inventory/' + selectedStore).once('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          for (const category in data) {
            let categoryHasItems = false;
            let categoryOutput = `${category.charAt(0).toUpperCase() + category.slice(1)}:\n`;
            for (const itemName in data[category]) {
              const itemValue = data[category][itemName];
              if (itemValue.trim() !== '') {
                categoryOutput += `${itemName}: ${itemValue}\n`;
                categoryHasItems = true;
              }
            }
            if (categoryHasItems) {
              output += categoryOutput + '\n';
            }
          }
        }
        document.getElementById('output-content').textContent = output || 'No items in inventory.';
      });
    }

    function copyInventoryList() {
      const outputContent = document.getElementById('output-content').textContent;
      if (outputContent.trim() === '') {
        showPopup('Please generate a list first.');
        return;
      }
      navigator.clipboard.writeText(outputContent)
        .then(() => showPopup('List copied to clipboard!'))
        .catch(err => showPopup('Failed to copy: ' + err));
    }

    async function clearInventory() {
      if (await customConfirm('Are you sure you want to clear all inventory items? This cannot be undone.')) {
        database.ref('inventory/' + selectedStore).remove()
          .then(() => {
            document.getElementById('output-content').textContent = 'Inventory cleared.';
            const inputs = document.querySelectorAll('.item-input');
            inputs.forEach(input => {
              input.value = '';
            });
          })
          .catch(error => showPopup('Error clearing inventory: ' + error.message));
      }
    }

    function setupEventListeners() {
      document.getElementById('generate-btn').addEventListener('click', generateInventoryList);
      document.getElementById('copy-btn').addEventListener('click', copyInventoryList);
      document.getElementById('clear-btn').addEventListener('click', clearInventory);
    }

    // ------------------ ADMIN PANEL Event Listeners ------------------
    document.getElementById('update-password-btn').addEventListener('click', async function() {
      const roleSelect = document.getElementById('password-role-select');
      const newPwdInput = document.getElementById('new-password-input');
      const selectedRole = roleSelect.value;
      const newPassword = newPwdInput.value.trim();
      if (!newPassword) {
        showPopup("Please enter a new password.");
        return;
      }
      if (selectedRole === "manager") {
        managerPassword = await hashPassword(newPassword);
      } else {
        storePasswords[selectedRole] = await hashPassword(newPassword);
      }
      database.ref('passwords').set({
        manager: managerPassword,
        store: storePasswords
      }).then(() => {
        showPopup("Password updated successfully.");
        newPwdInput.value = '';
      }).catch(err => showPopup("Error updating password: " + err.message));
    });

    document.getElementById('reset-password-btn').addEventListener('click', async function() {
      if (await customConfirm("Are you sure you want to reset all passwords to default?")) {
        managerPassword = await hashPassword(DEFAULT_MANAGER_PASSWORD);
        const newStorePasswords = {};
        for (const store in DEFAULT_STORE_PASSWORDS) {
          newStorePasswords[store] = await hashPassword(DEFAULT_STORE_PASSWORDS[store]);
        }
        storePasswords = newStorePasswords;
        database.ref('passwords').set({
          manager: managerPassword,
          store: storePasswords
        }).then(() => {
          showPopup("All passwords have been reset to default.");
        }).catch(err => showPopup("Error resetting passwords: " + err.message));
      }
    });

    document.getElementById('sign-out-all-btn').addEventListener('click', async function() {
      if (await customConfirm("This will sign out everyone currently using the app. Proceed?")) {
        database.ref('global/signOutTrigger').set(Date.now())
          .then(() => showPopup("All users have been signed out."))
          .catch(error => showPopup("Error signing out users: " + error.message));
      }
    });
  </script>
</body>
</html>
